<!DOCTYPE html>  <html> <head>   <title>router.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="application.html">                 application.coffee               </a>                                           <a class="source" href="collection-view.html">                 collection-view.coffee               </a>                                           <a class="source" href="collection.html">                 collection.coffee               </a>                                           <a class="source" href="composite-view.html">                 composite-view.coffee               </a>                                           <a class="source" href="error-model.html">                 error-model.coffee               </a>                                           <a class="source" href="form-view.html">                 form-view.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="item-view.html">                 item-view.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="region-manager.html">                 region-manager.coffee               </a>                                           <a class="source" href="router.html">                 router.coffee               </a>                                           <a class="source" href="store.html">                 store.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="view-model.html">                 view-model.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               router.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Backbone = </span><span class="nx">require</span> <span class="s">&#39;backbone&#39;</span>
<span class="nv">_        = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The highbrow router is heavily inspired by page.js:
http://visionmedia.github.com/page.js/</p>

<p>This version is also usable on the server (no dependency
on document being defined). Multiple routers can be 
nested, allowing an app to be composed of multiple 
pieces and joined together.</p>

<p>var app = new Router()</p>

<p>app.page('/', middleware, handler);
var dashboard = app.mount(
  new Router('/dashboard', dashboard.middleware));
dashboard.page('', dashboard.root);
dashboard.page('new', dashboard.newPage);</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Context is the object that is passed to each
route function. Intermediate data can be
attached to the object as needed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Context</span>
  <span class="nv">constructor: </span><span class="nf">(@path, @state={}, @root) -&gt;</span>
    <span class="vi">@params = </span><span class="p">[]</span>
    <span class="vi">@canonicalPath = </span><span class="nx">@path</span>
    <span class="vi">@state.path = </span><span class="nx">@path</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The internal implementation of each page.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Route</span>
  <span class="nv">constructor: </span><span class="nf">(@path, fns...) -&gt;</span>
    <span class="vi">@keys = </span><span class="p">[]</span>
    <span class="vi">@fns = </span><span class="nx">fns</span>
    <span class="vi">@regexp = </span><span class="nx">@pathtoRegexp</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span>

  <span class="nv">dispatch: </span><span class="nf">(ctx, callback) -&gt;</span>
    <span class="nv">i = </span><span class="mi">0</span>
    <span class="nv">next = </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">or</span> <span class="nx">i</span><span class="o">==</span><span class="nx">@fns</span><span class="p">.</span><span class="nx">length</span>

      <span class="nv">fn = </span><span class="nx">@fns</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">))</span>

    <span class="nx">next</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Check if this route matches <code>path</code>.
If it does, populate <code>params</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">match: </span><span class="nf">(path, params=[]) -&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">path</span><span class="o">==</span><span class="nx">@path</span>

    <span class="nv">qsIndex = </span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
    <span class="nv">pathname = </span><span class="k">if</span> <span class="o">~</span><span class="nx">qsIndex</span> <span class="k">then</span> <span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">qsIndex</span><span class="p">)</span> <span class="k">else</span> <span class="nx">path</span>
    <span class="nv">match = </span><span class="k">this</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">match</span>


    <span class="k">for</span> <span class="nx">m</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span>
      <span class="nv">val = </span><span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;string&#39;</span> <span class="k">then</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">else</span> <span class="nx">m</span>
      <span class="nv">key = </span><span class="nx">@keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">key</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
      <span class="k">else</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>

    <span class="nx">params</span>


  <span class="nv">pathtoRegexp: </span><span class="nf">(p) -&gt;</span>
    <span class="k">return</span> <span class="nx">p</span> <span class="k">if</span> <span class="nx">p</span> <span class="k">instanceof</span> <span class="nb">RegExp</span>
    <span class="nv">p = </span><span class="s">&quot;(</span><span class="si">#{</span><span class="nx">p</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">)&quot;</span> <span class="k">if</span> <span class="nx">p</span> <span class="k">instanceof</span> <span class="nb">Array</span>
    <span class="nx">p</span> <span class="o">+=</span> <span class="s">&#39;/?&#39;</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/\(/g</span><span class="p">,</span> <span class="s">&#39;(?:/&#39;</span><span class="p">)</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\+/g</span><span class="p">,</span> <span class="s">&#39;__plus__&#39;</span><span class="p">)</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">ign</span><span class="p">,</span> <span class="nx">slash</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">capture</span><span class="p">,</span> <span class="nx">optional</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@keys</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nv">name: </span><span class="nx">key</span><span class="p">,</span> <span class="nv">optional: </span><span class="o">!!</span> <span class="nx">optional</span> <span class="p">})</span>
      <span class="nv">slash = </span><span class="nx">slash</span> <span class="o">||</span> <span class="s">&#39;&#39;</span>
      <span class="nv">result = </span><span class="k">if</span> <span class="nx">optional</span> <span class="k">then</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="nx">slash</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="s">&#39;(?:&#39;</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="k">if</span> <span class="nx">optional</span> <span class="k">then</span> <span class="nx">slash</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">format</span> <span class="o">||</span> <span class="s">&#39;&#39;</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">capture</span> <span class="o">||</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&amp;&amp;</span> <span class="s">&#39;([^/.]+?)&#39;</span> <span class="o">||</span> <span class="s">&#39;([^/]+?)&#39;</span><span class="p">))</span> 
      <span class="nx">result</span> <span class="o">+=</span> <span class="s">&#39;)&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">optional</span> <span class="o">||</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="nx">result</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([\/.])/g</span><span class="p">,</span> <span class="s">&#39;\\$1&#39;</span><span class="p">)</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/__plus__/g</span><span class="p">,</span> <span class="s">&#39;(.+)&#39;</span><span class="p">)</span>
    <span class="nv">p = </span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span> <span class="s">&#39;(.*)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This is the entry point to highbrow's router.
Create a new instance of the router, and attach
pages to it:</p>

<p>router = new Router('/app')</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Router</span>
  <span class="vi">@canNavigateAway = </span><span class="o">-&gt;</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The router can be mapped to a subpath, by
passing that in as the first parameter to the
constructor.</p>

<p>Default routing functions can also be attached
to the router, that will be called when any
path on this router matches.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@base=&#39;&#39;, fns...) -&gt;</span>
    <span class="vi">@running = </span><span class="kc">false</span>
    <span class="vi">@routes = </span><span class="p">[]</span>
    <span class="vi">@routers = </span><span class="p">{}</span>
    <span class="vi">@baseRoute = </span><span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="nx">@base</span><span class="o">+</span><span class="s">&#39;/*&#39;</span><span class="p">,</span> <span class="nx">fns</span><span class="p">...)</span>

  <span class="nv">match: </span><span class="nf">(path, params) -&gt;</span>
    <span class="nv">p = </span><span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s">&#39;/&#39;</span> <span class="k">then</span> <span class="nx">path</span> <span class="k">else</span> <span class="nx">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
    <span class="nx">@baseRoute</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Define a new page on the router.
The path can contain:
page('/user/:user', load, show) // parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">page: </span><span class="nf">(path, fns...) -&gt;</span>
    <span class="nx">@routes</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="nx">@base</span><span class="o">+</span><span class="nx">path</span><span class="p">,</span> <span class="nx">fns</span><span class="p">...)</span>
    <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Route to the given path, with an optional state and callback</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">show: </span><span class="nf">(path, state, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="nv">callback = </span><span class="nx">state</span>
      <span class="nv">state = </span><span class="p">{}</span>


    <span class="nx">@dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">Context</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">@</span><span class="p">),</span> <span class="nx">callback</span><span class="p">)</span>

  <span class="nv">dispatch: </span><span class="nf">(ctx, callback) -&gt;</span>
    <span class="nx">@trigger</span> <span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="nx">ctx</span>

    <span class="nv">finish = </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">result</span>
      <span class="k">else</span>
        <span class="nx">@trigger</span> <span class="s">&#39;show&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">result</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nx">ctx</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>

    <span class="nx">@baseRoute</span><span class="p">.</span><span class="nx">dispatch</span> <span class="nx">ctx</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Find a match from this router first</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">route = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">@routes</span><span class="p">,</span> <span class="nf">(r) -&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">route</span><span class="p">.</span><span class="nx">dispatch</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">finish</span> <span class="k">if</span> <span class="nx">route</span>

      <span class="nv">router = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">@routers</span><span class="p">,</span> <span class="nf">(router,base) -&gt;</span>
        <span class="nx">router</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">router</span><span class="p">.</span><span class="nx">dispatch</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">finish</span> <span class="k">if</span> <span class="nx">router</span>

      <span class="k">return</span> <span class="nx">@trigger</span><span class="p">(</span><span class="s">&#39;unhandled&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>When called from the browser, this will dispatch to the route
matching the browser's current location.</p>

<p>An optional callback will be called when routing has finished</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">start: </span><span class="nf">(callback) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@running</span>
    <span class="vi">@running = </span><span class="kc">true</span>
    <span class="nx">@install</span><span class="p">()</span>
    <span class="nx">@replace</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="o">+</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>

  <span class="nv">stop: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Replace <code>path</code> with optional <code>state</code> object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">replace: </span><span class="nf">(path, state, init, callback) -&gt;</span>
    <span class="nv">ctx = </span><span class="k">new</span> <span class="nx">Context</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span>
    <span class="nv">ctx.replace = </span><span class="kc">true</span>
    <span class="nv">ctx.init = </span><span class="nx">init</span>
    <span class="nx">@dispatch</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Mount a new router at the given base. This lets you nest different
segments of your application.</p>

<p>For example, you can mount an admin section, and ensure the user
is authenticated before following any of its pages:</p>

<p>var admin = router.mount('/admin', ensureUserIsAdmin);
admin.page('', adminRoutes.rootPage);
admin.page('/dashboard', adminRoutes.dashboard);</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mount: </span><span class="nf">(base, fns...) -&gt;</span>
    <span class="nx">@routers</span><span class="p">[</span><span class="nx">@base</span><span class="o">+</span><span class="nx">base</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">(</span><span class="nx">@base</span><span class="o">+</span><span class="nx">base</span><span class="p">,</span> <span class="nx">fns</span><span class="p">...)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Install is called from start, and will install the
pushState,popState event handlers for the html5 history api.
It will also install an onclick handler that will intercept
any matching routes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">install: </span><span class="o">-&gt;</span>
    <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;show&#39;</span><span class="p">,</span> <span class="nf">(ctx) -&gt;</span>
      <span class="k">if</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">replace</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>console.log "replacestate: ", ctx.state, ctx.canonicalPath</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canonicalPath</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>console.log "pushstate: ", ctx.state, ctx.canonicalPath</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canonicalPath</span>

    <span class="nv">onpopstate = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@replace</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">state</span>

    <span class="nv">onclick = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>console.log "router: onclick", e</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">defaultPrevented</span>
      <span class="nv">el = </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span>
      <span class="nv">el = </span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="k">while</span> <span class="nx">el</span> <span class="o">and</span> <span class="s">&#39;A&#39;</span> <span class="o">!=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">nodeName</span>
      <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">el</span> <span class="o">or</span> <span class="s">&#39;A&#39;</span> <span class="o">!=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">nodeName</span>

      <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">Router</span><span class="p">.</span><span class="nx">canNavigateAway</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

      <span class="nv">href = </span><span class="nx">el</span><span class="p">.</span><span class="nx">href</span>
      <span class="nv">path = </span><span class="nx">el</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">search</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">el</span><span class="p">.</span><span class="nx">hash</span> <span class="o">or</span> <span class="o">!</span><span class="nx">sameOrigin</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span>

      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="nx">@show</span> <span class="nx">path</span>

    <span class="nv">sameOrigin = </span><span class="nf">(href) -&gt;</span>
      <span class="nv">origin = </span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span>
      <span class="nx">origin</span> <span class="o">+=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="k">if</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span>
      <span class="mi">0</span> <span class="o">==</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">origin</span><span class="p">)</span>

    <span class="nx">addEventListener</span> <span class="s">&#39;popstate&#39;</span><span class="p">,</span> <span class="nx">onpopstate</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nx">addEventListener</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nx">onclick</span><span class="p">,</span> <span class="kc">false</span>

<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Router</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">)</span>

<span class="nv">module.exports = </span><span class="nx">Router</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 